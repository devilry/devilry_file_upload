<!DOCTYPE html>
<html>
    <head>
        <title>jQuery multifile drag and drop</title>

        <!-- We use bootstrap to get a good set of default body styles. You can
             remove this, and provide your own default styles. -->
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <style type="text/css">
            .content {
                margin: 30px auto 0 auto;
                max-width: 600px;
            }
        </style>
        <link href="../css/widgets.css" rel="stylesheet">
    </head>

    <body>
        <div class="content">
            <div id="uploadedFiles"></div>
            <div id="fileUploadProgressContainer"></div>
            <div id="fileUpload" class="FileUploadWidget FileUploadWidgetSlimLineExpand"></div>
        </div>

        <script src="../js/devilry_file_upload.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../js/jquerywidgets.js"></script>
        <script>

            /*
            Called when an upload succeeds.
            (Called from the success-event handler for the asyncFileUploader in handleUploadStart())
            */
            function handleUploadSuccess(asyncFileUploader, jsonData) {
                var files = asyncFileUploader.getFileobjectsByName();
                var i;
                for(i=0; i<jsonData.uploaded_files.length; i++) {
                    var uploadedFile = jsonData.uploaded_files[i];
                    var uploadedFileWidget = new devilry_file_upload.jquery.UploadedFilePreviewWidget({
                        previewFile: files[uploadedFile.filename], // Generate preview from the local file (only in modern browsers)
                        // previewUrl: jsonData.preview_url, // Use a preview generated by you on the server
                        renderFunction: function() {
                            // NOTE: You would typically use a template engine, like Mustache, here.
                            return [
                                '<div class="UploadedFilePreviewWidget GrayRow">',
                                    '<div class="preview"></div>',
                                    '<div class="filename">',
                                        uploadedFile.filename,
                                    '</div>',
                                    '<button type="button" class="deleteButton closeButtonDanger">&times;</button>',
                                    '<div class="deletingMessage">',
                                        'Deleting...',
                                    '</div>',
                                '</div>'
                            ].join('');
                        },

                        // This is forwarded to jQuery.ajax when deleting the file.
                        // If deleteRequestArgs is null or undefined, the delete button is not shown.
                        // Note that the widget sets ``succes``, error`` and ``complete``, so setting
                        // them will have no effect.
                        deleteRequestArgs: {
                            url: uploadedFile.delete_url,
                            processData: false,
                            type: 'DELETE',
                            data: JSON.stringify({
                                filename: uploadedFile.filename
                            })
                        },
                        listeners: {
                            deleteSuccess: function(widget, data, status) {
                                //console.log('delete successful', data, status);
                            },
                            deleteError: function(widget, jqXHR, textStatus, errorThrown) {
                                //console.log('delete failed', textStatus, errorThrown);
                                alert('Could not delete "' + uploadedFileWidget.filename
                                    + '". Please try again.');
                            }
                        }
                    });
                    $('#uploadedFiles').append(uploadedFileWidget.elementJq);
                }
            }


            /*
            Called when an upload starts.
            (Configured in the constructor for devilry_file_upload.FileUpload)
            */
            function handleUploadStart(fileUpload, asyncFileUploader) {
                var uploadProgressWidget = new devilry_file_upload.jquery.FileUploadProgressWidget({
                    fileUpload: fileUpload,
                    asyncFileUploader: asyncFileUploader,
                    renderFunction: function(asyncFileUploader) {
                        // NOTE: You would typically use a template engine, like Mustache, here.
                        return [
                            '<div class="FileUploadProgressWidget GrayRow large">',
                                '<div class="inlineProgress">',
                                    '<div class="bar"></div>',
                                '</div>',
                                ' Uploading ',
                                this.asyncFileUploader.getFilenames().join(', '),
                                '<button type="button" class="abortButton closeButtonDanger">&times;</button>',
                            '</div>'
                        ].join('');
                    }
                });
                $('#fileUploadProgressContainer').append(uploadProgressWidget.elementJq);

                asyncFileUploader.on('finished', function(asyncFileUploader, data) {
                    // In uploadFinished, we parse the response from the
                    // server, and add the uploaded files to the
                    // uploadedFilesWidget.
                    jsonData = jQuery.parseJSON(data);
                    if(jsonData.success) {
                        handleUploadSuccess(asyncFileUploader, jsonData);
                    } else {
                        alert("Error: " + jsonData.error);
                    }
                });

                asyncFileUploader.on('abort', function(asyncFileUploader) {
                    alert('Upload was aborted. This example does not handle partial uploads, so you will probably have a partially uploaded file in your examples/ folder.');
                });
                asyncFileUploader.on('error', function(asyncFileUploader, e) {
                    alert('The upload failed.');
                    uploadProgressWidget.destroy();
                });
            }
            


            ///////////////////////////////////////////////////
            // 
            // Setup our file upload UI
            //
            ///////////////////////////////////////////////////

            devilry_file_upload.prevent_default_window_drophandler();
            var fileUpload = new devilry_file_upload.FileUpload({
                // The FileUpload API is plain JS (no jQuery), so we have to
                // send in the html elements, not the jQuery objects.
                containerElement: $('#fileUpload').get(0),

                // Eventlisteners
                listeners: {
                    uploadStart: handleFileUploadStart
                },

                // Enable drag and dropping files into one of the elements in the widget
                dropTargetSelector: '.dropTarget',

                // Render the widget
                widgetRenderFunction: function() {
                    return [
                        '<form action="/upload" method="post" enctype="multipart/form-data">',
                            '<input type="file" name="files" multiple>',
                        '</form>',
                        '<div class="dragHelp">',
                            'Add files by dragging and dropping them into this box, or ',
                            'by <a href="#" class="fileUploadButton">uploading them</a>.',
                        '</div>',
                        '<div class="dropHelp">Drop your files to upload them.</div>',
                        '<div class="dropTarget"></div>'
                    ].join('');
                },
            });
            var fileUploadWidget = new devilry_file_upload.jquery.FileUploadWidget({
                fileUpload: fileUpload
            });
        </script>
    </body>
</html>
