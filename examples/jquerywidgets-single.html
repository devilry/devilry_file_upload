<!DOCTYPE html>
<html>
    <head>
        <title>jQuery single file upload</title>

        <!-- We use bootstrap to get a good set of default body styles. You can
             remove this, and provide your own default styles. -->
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <style type="text/css">
            .PictureFrame {
                margin: 30px auto 0 auto;
            }
        </style>
        <link href="../css/widgets.css" rel="stylesheet">
    </head>

    <body>
        <div class="content">
            <div id="uploadedFile"></div>
            <div id="fileUploadProgressContainer"></div>
            <div id="fileUpload" class="FileUploadWidget PictureFrame"></div>
        </div>

        <script src="../js/devilry_file_upload.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../js/jquerywidgets.js"></script>
        <script>

            /*
            Called when an upload succeeds.
            (Called from the success-event handler for the asyncFileUploader in handleUploadStart())
            */
            function handleUploadSuccess(fileUpload, asyncFileUploader, jsonData) {
                var files = asyncFileUploader.getFileobjectsByName();
                var i;
                for(i=0; i<jsonData.uploaded_files.length; i++) {
                    var uploadedFile = jsonData.uploaded_files[i];
                    var uploadedFileWidget = new devilry_file_upload.jquery.UploadedFilePreviewWidget({
                        previewFile: files[uploadedFile.filename], // Generate preview from the local file (only in modern browsers)
                        // previewUrl: jsonData.preview_url, // Use a preview generated by you on the server
                        renderFunction: function() {
                            // NOTE: You would typically use a template engine, like Mustache, here.
                            return [
                                '<div class="UploadedFilePreviewWidget PictureFrame">',
                                    '<div class="preview"></div>',
                                    '<div class="filename">', uploadedFile.filename, '</div>',
                                    '<button type="button" class="deleteButton closeButtonDanger">&times;</button>',
                                    '<div class="deletingMessage">Deleting...</div>',
                                '</div>'
                            ].join('');
                        },

                        // Format the delete request for your delete API.. This works with the example server.
                        deleteRequestArgs: {
                            url: uploadedFile.delete_url,
                            processData: false,
                            type: 'DELETE',
                            data: JSON.stringify({
                                filename: uploadedFile.filename
                            })
                        },

                        listeners: {
                            deleteSuccess: function(widget, data, status) {
                                // Resume the fileUpload. Causes the
                                // FileUploadWidget to re-show itself, and the
                                // FileUpload to allow uploads.
                                fileUpload.resume();
                            },
                            deleteError: function(widget, jqXHR, textStatus, errorThrown) {
                                //console.log('delete failed', textStatus, errorThrown);
                                alert('Could not delete "' + uploadedFileWidget.filename
                                    + '". Please try again.');
                            }
                        }
                    });
                    $('#uploadedFile').append(uploadedFileWidget.elementJq);
                }
            }


            /*
            Called when an upload starts.
            (Configured in the constructor for devilry_file_upload.FileUpload)
            */
            function handleUploadStart(fileUpload, asyncFileUploader) {
                if(asyncFileUploader.hasMultipleFiles()) {
                    alert('You can only upload a single file.');
                    return new devilry_file_upload.ObservableResult({
                        abort: true
                    });
                }

                // Pause the fileUpload to prevent further uploads.
                // - this also tells the FileUploadWidget to hide itself.
                fileUpload.pause();

                var uploadProgressWidget = new devilry_file_upload.jquery.FileUploadProgressWidget({
                    fileUpload: fileUpload,
                    asyncFileUploader: asyncFileUploader,
                    renderFunction: function(asyncFileUploader) {
                        // NOTE: You would typically use a template engine, like Mustache, here.
                        return [
                            '<div class="FileUploadProgressWidget PictureFrame">',
                                '<div class="inlineProgress"><div class="bar"></div></div>',
                                ' Uploading ', this.asyncFileUploader.getFilenames().join(', '),
                                '<button type="button" class="abortButton closeButtonDanger">&times;</button>',
                            '</div>'
                        ].join('');
                    }
                });
                $('#fileUploadProgressContainer').append(uploadProgressWidget.elementJq);

                asyncFileUploader.on('finished', function(asyncFileUploader, data) {
                    // In uploadFinished, we parse the response from the
                    // server, and add the uploaded files to the
                    // uploadedFilesWidget.
                    jsonData = jQuery.parseJSON(data);
                    if(jsonData.success) {
                        handleUploadSuccess(fileUpload, asyncFileUploader, jsonData);
                    } else {
                        fileUpload.resume();
                        alert("Error: " + jsonData.error);
                    }
                });

                asyncFileUploader.on('abort', function(asyncFileUploader) {
                    alert('Upload was aborted. This example does not handle partial uploads, so you will probably have a partially uploaded file in your examples/ folder.');
                    fileUpload.resume();
                });
                asyncFileUploader.on('error', function(asyncFileUploader, e) {
                    alert('The upload failed.');
                    fileUpload.resume();
                    uploadProgressWidget.destroy();
                });
            }



            ///////////////////////////////////////////////////
            // 
            // Setup our file upload UI
            //
            ///////////////////////////////////////////////////

            devilry_file_upload.prevent_default_window_drophandler();
            var fileUpload = new devilry_file_upload.FileUpload({
                // The FileUpload API is plain JS (no jQuery), so we have to
                // send in the html elements, not the jQuery objects.
                containerElement: $('#fileUpload').get(0),

                dropTargetSelector: '.dropTarget',
                listeners: {
                    uploadStart: handleUploadStart
                },
                widgetRenderFunction: function() {
                    return [
                        '<form action="/upload" method="post" enctype="multipart/form-data">',
                            '<input type="file" name="files">',
                        '</form>',
                        '<div class="dragHelp">',
                            'Drag a file into this box, or ',
                            '<a href="#" class="fileUploadButton">upload one</a>.',
                        '</div>',
                        '<div class="dropHelp">Drop your file to upload it.</div>',
                        '<div class="dropTarget"></div>'
                    ].join('');
                },
            });
            var fileUploadWidget = new devilry_file_upload.jquery.FileUploadWidget({
                fileUpload: fileUpload
            });
        </script>
    </body>
</html>
